'use strict';

exports.__esModule = true;

var _declaration = require('postcss/lib/declaration');

var _declaration2 = _interopRequireDefault(_declaration);

var _comment = require('postcss/lib/comment');

var _comment2 = _interopRequireDefault(_comment);

var _atRule = require('postcss/lib/at-rule');

var _atRule2 = _interopRequireDefault(_atRule);

var _rule = require('postcss/lib/rule');

var _rule2 = _interopRequireDefault(_rule);

var _root = require('postcss/lib/root');

var _root2 = _interopRequireDefault(_root);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Parser = function () {
    function Parser(input) {
        _classCallCheck(this, Parser);

        this.input = input;

        this.pos = 0;
        this.root = new _root2.default();
        this.current = this.root;
        this.spaces = '';

        this.prevIndent = undefined;
        this.step = undefined;

        this.root.source = { input: input, start: { line: 1, column: 1 } };
    }

    Parser.prototype.loop = function loop() {
        var part = void 0;
        while (this.pos < this.parts.length) {
            part = this.parts[this.pos];

            if (part.comment) {
                this.comment(part);
            } else if (part.atrule) {
                this.atrule(part);
            } else if (part.colon) {
                var next = this.nextNonComment(this.pos);

                if (next.end || next.atrule) {
                    this.decl(part);
                } else {
                    var sameIndent = next.indent.length === part.indent.length;
                    if (sameIndent) {
                        this.decl(part);
                    } else if (!sameIndent && next.colon) {
                        this.rule(part);
                    } else if (!sameIndent && !next.colon) {
                        this.decl(part);
                    }
                }
            } else if (part.end) {
                this.root.raws.after = part.before;
            } else {
                this.rule(part);
            }

            this.pos += 1;
        }
    };

    Parser.prototype.comment = function comment(part) {
        var token = part.tokens[0];
        var node = new _comment2.default();
        this.init(node, part);
        node.source.end = { line: token[4], column: token[5] };

        var text = token[1];
        if (token[6] === 'inline') {
            node.raws.inline = true;
            text = text.slice(2);
        } else {
            text = text.slice(2, -2);
        }

        var match = text.match(/^(\s*)([^]*[^\s])(\s*)\n?$/);
        node.text = match[2];
        node.raws.left = match[1];
        node.raws.inlineRight = match[3];
    };

    Parser.prototype.atrule = function atrule(part) {
        var atword = part.tokens[0];
        var params = part.tokens.slice(1);

        var node = new _atRule2.default();
        node.name = atword[1].slice(1);
        this.init(node, part);

        if (node.name === '') this.unnamedAtrule(atword);

        while (!part.end && part.lastComma) {
            this.pos += 1;
            part = this.parts[this.pos];
            params.push(['space', part.before + part.indent]);
            params = params.concat(part.tokens);
        }

        node.raws.afterName = this.firstSpaces(params);
        this.keepTrailingSpace(node, params);
        this.raw(node, 'params', params, atword);
    };

    Parser.prototype.decl = function decl(part) {
        var node = new _declaration2.default();
        this.init(node, part);

        var between = '';
        var colon = 0;
        var value = [];
        var prop = '';
        for (var i = 0; i < part.tokens.length; i++) {
            var token = part.tokens[i];
            if (token[0] === ':') {
                between += token[1];
                colon = token;
                value = part.tokens.slice(i + 1);
                break;
            } else if (token[0] === 'comment' || token[0] === 'space') {
                between += token[1];
            } else if (between !== '') {
                this.badProp(token);
            } else {
                prop += token[1];
            }
        }

        if (prop === '') this.unnamedDecl(part.tokens[0]);
        node.prop = prop;

        var next = this.parts[this.pos + 1];

        while (!next.end && !next.atrule && !next.colon && next.indent.length > part.indent.length) {
            value.push(['space', next.before + next.indent]);
            value = value.concat(next.tokens);
            this.pos += 1;
            next = this.parts[this.pos + 1];
        }

        for (var _i = value.length - 1; _i > 0; _i--) {
            var t = value[_i][0];
            if (t === 'word' && value[_i][1] === '!important') {
                node.important = true;
                if (_i > 0 && value[_i - 1][0] === 'space') {
                    node.raws.important = value[_i - 1][1] + '!important';
                    value.splice(_i - 1, 2);
                } else {
                    node.raws.important = '!important';
                    value.splice(_i, 1);
                }
                break;
            } else if (t !== 'space' && t !== 'newline' && t !== 'comment') {
                break;
            }
        }

        node.raws.between = between + this.firstSpaces(value);
        this.raw(node, 'value', value, colon);
    };

    Parser.prototype.rule = function rule(part) {
        var node = new _rule2.default();
        this.init(node, part);

        var selector = part.tokens;
        var next = this.parts[this.pos + 1];

        while (!next.end && next.indent.length === part.indent.length) {
            selector.push(['space', next.before + next.indent]);
            selector = selector.concat(next.tokens);
            this.pos += 1;
            next = this.parts[this.pos + 1];
        }

        this.keepTrailingSpace(node, selector);
        this.raw(node, 'selector', selector);
    };

    /* Helpers */

    Parser.prototype.indent = function indent(part) {
        var indent = part.indent.length;
        var isPrev = typeof this.prevIndent !== 'undefined';

        if (!isPrev && indent) this.indentedFirstLine(part);

        if (!this.step && indent) {
            this.step = indent;
            this.root.raws.indent = part.indent;
        }

        if (isPrev && this.prevIndent !== indent) {
            var diff = indent - this.prevIndent;
            if (diff > 0) {
                if (diff !== this.step) {
                    this.wrongIndent(this.prevIndent + this.step, indent, part);
                } else {
                    this.current = this.current.last;
                }
            } else if (diff % this.step !== 0) {
                var m = indent + diff % this.step;
                this.wrongIndent(m + ' or ' + (m + this.step), indent, part);
            } else {
                for (var i = 0; i < -diff / this.step; i++) {
                    this.current = this.current.parent;
                }
            }
        }

        this.prevIndent = indent;
    };

    Parser.prototype.init = function init(node, part) {
        this.indent(part);

        if (!this.current.nodes) this.current.nodes = [];
        this.current.push(node);

        node.raws.before = part.before + part.indent;
        node.source = {
            start: { line: part.tokens[0][2], column: part.tokens[0][3] },
            input: this.input
        };
    };

    Parser.prototype.keepTrailingSpace = function keepTrailingSpace(node, tokens) {
        var lastSpace = tokens[tokens.length - 1];
        if (lastSpace && lastSpace[0] === 'space') {
            tokens.pop();
            node.raws.sssBetween = lastSpace[1];
        }
    };

    Parser.prototype.firstSpaces = function firstSpaces(tokens) {
        var result = '';
        for (var i = 0; i < tokens.length; i++) {
            if (tokens[i][0] === 'space' || tokens[i][0] === 'newline') {
                result += tokens.shift()[1];
                i -= 1;
            } else {
                break;
            }
        }
        return result;
    };

    Parser.prototype.raw = function raw(node, prop, tokens, altLast) {
        var token = void 0,
            type = void 0;
        var length = tokens.length;
        var value = '';
        var clean = true;
        for (var i = 0; i < length; i += 1) {
            token = tokens[i];
            type = token[0];
            if (type === 'comment' || type === 'space' && i === length - 1) {
                clean = false;
            } else {
                value += token[1];
            }
        }
        if (!clean) {
            var sss = tokens.reduce(function (all, i) {
                return all + i[1];
            }, '');
            var raw = tokens.reduce(function (all, i) {
                if (i[0] === 'comment' && i[6] === 'inline') {
                    return all + '/* ' + i[1].slice(2).trim() + ' */';
                } else {
                    return all + i[1];
                }
            }, '');
            node.raws[prop] = { value: value, raw: raw };
            if (sss !== raw) node.raws[prop].sss = sss;
        }
        node[prop] = value;

        var last = tokens[tokens.length - 1] || altLast;
        node.source.end = {
            line: last[4] || last[2],
            column: last[5] || last[3]
        };
    };

    Parser.prototype.nextNonComment = function nextNonComment(pos) {
        var next = pos;
        var part = void 0;
        while (next < this.parts.length) {
            next += 1;
            part = this.parts[next];
            if (part.end || !part.comment) break;
        }
        return part;
    };

    // Errors

    Parser.prototype.error = function error(msg, line, column) {
        throw this.input.error(msg, line, column);
    };

    Parser.prototype.unnamedAtrule = function unnamedAtrule(token) {
        this.error('At-rule without name', token[2], token[3]);
    };

    Parser.prototype.unnamedDecl = function unnamedDecl(token) {
        this.error('Declaration without name', token[2], token[3]);
    };

    Parser.prototype.indentedFirstLine = function indentedFirstLine(part) {
        this.error('First line should not have indent', part.number, 1);
    };

    Parser.prototype.wrongIndent = function wrongIndent(expected, real, part) {
        var msg = 'Expected ' + expected + ' indent, but get ' + real;
        this.error(msg, part.number, 1);
    };

    Parser.prototype.badProp = function badProp(token) {
        this.error('Unexpected separator in property', token[2], token[3]);
    };

    return Parser;
}();

exports.default = Parser;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,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RUFBaUM7QUFDcEM7QUFDRCxlQUFPLElBQVA7QUFDSCxLOzs7O3FCQUlELEssa0JBQU0sRyxFQUFLLEksRUFBTSxNLEVBQVE7QUFDckIsY0FBTSxLQUFLLEtBQUwsQ0FBVyxLQUFYLENBQWlCLEdBQWpCLEVBQXNCLElBQXRCLEVBQTRCLE1BQTVCLENBQU47QUFDSCxLOztxQkFFRCxhLDBCQUFjLEssRUFBTztBQUNqQixhQUFLLEtBQUwsQ0FBVyxzQkFBWCxFQUFtQyxNQUFNLENBQU4sQ0FBbkMsRUFBNkMsTUFBTSxDQUFOLENBQTdDO0FBQ0gsSzs7cUJBRUQsVyx3QkFBWSxLLEVBQU87QUFDZixhQUFLLEtBQUwsQ0FBVywwQkFBWCxFQUF1QyxNQUFNLENBQU4sQ0FBdkMsRUFBaUQsTUFBTSxDQUFOLENBQWpEO0FBQ0gsSzs7cUJBRUQsaUIsOEJBQWtCLEksRUFBTTtBQUNwQixhQUFLLEtBQUwsQ0FBVyxtQ0FBWCxFQUFnRCxLQUFLLE1BQXJELEVBQTZELENBQTdEO0FBQ0gsSzs7cUJBRUQsVyx3QkFBWSxRLEVBQVUsSSxFQUFNLEksRUFBTTtBQUM5QixZQUFJLG9CQUFtQixRQUFuQix5QkFBaUQsSUFBckQ7QUFDQSxhQUFLLEtBQUwsQ0FBVyxHQUFYLEVBQWdCLEtBQUssTUFBckIsRUFBNkIsQ0FBN0I7QUFDSCxLOztxQkFFRCxPLG9CQUFRLEssRUFBTztBQUNYLGFBQUssS0FBTCxDQUFXLGtDQUFYLEVBQStDLE1BQU0sQ0FBTixDQUEvQyxFQUF5RCxNQUFNLENBQU4sQ0FBekQ7QUFDSCxLOzs7OztrQkFuVGdCLE0iLCJmaWxlIjoicGFyc2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IERlY2xhcmF0aW9uIGZyb20gJ3Bvc3Rjc3MvbGliL2RlY2xhcmF0aW9uJztcbmltcG9ydCBDb21tZW50ICAgICBmcm9tICdwb3N0Y3NzL2xpYi9jb21tZW50JztcbmltcG9ydCBBdFJ1bGUgICAgICBmcm9tICdwb3N0Y3NzL2xpYi9hdC1ydWxlJztcbmltcG9ydCBSdWxlICAgICAgICBmcm9tICdwb3N0Y3NzL2xpYi9ydWxlJztcbmltcG9ydCBSb290ICAgICAgICBmcm9tICdwb3N0Y3NzL2xpYi9yb290JztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUGFyc2VyIHtcblxuICAgIGNvbnN0cnVjdG9yKGlucHV0KSB7XG4gICAgICAgIHRoaXMuaW5wdXQgPSBpbnB1dDtcblxuICAgICAgICB0aGlzLnBvcyAgICAgPSAwO1xuICAgICAgICB0aGlzLnJvb3QgICAgPSBuZXcgUm9vdCgpO1xuICAgICAgICB0aGlzLmN1cnJlbnQgPSB0aGlzLnJvb3Q7XG4gICAgICAgIHRoaXMuc3BhY2VzICA9ICcnO1xuXG4gICAgICAgIHRoaXMucHJldkluZGVudCA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5zdGVwICAgICAgID0gdW5kZWZpbmVkO1xuXG4gICAgICAgIHRoaXMucm9vdC5zb3VyY2UgPSB7IGlucHV0LCBzdGFydDogeyBsaW5lOiAxLCBjb2x1bW46IDEgfSB9O1xuICAgIH1cblxuICAgIGxvb3AoKSB7XG4gICAgICAgIGxldCBwYXJ0O1xuICAgICAgICB3aGlsZSAoIHRoaXMucG9zIDwgdGhpcy5wYXJ0cy5sZW5ndGggKSB7XG4gICAgICAgICAgICBwYXJ0ID0gdGhpcy5wYXJ0c1t0aGlzLnBvc107XG5cbiAgICAgICAgICAgIGlmICggcGFydC5jb21tZW50ICkge1xuICAgICAgICAgICAgICAgIHRoaXMuY29tbWVudChwYXJ0KTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoIHBhcnQuYXRydWxlICkge1xuICAgICAgICAgICAgICAgIHRoaXMuYXRydWxlKHBhcnQpO1xuICAgICAgICAgICAgfSBlbHNlIGlmICggcGFydC5jb2xvbiApIHtcbiAgICAgICAgICAgICAgICBsZXQgbmV4dCA9IHRoaXMubmV4dE5vbkNvbW1lbnQodGhpcy5wb3MpO1xuXG4gICAgICAgICAgICAgICAgaWYgKCBuZXh0LmVuZCB8fCBuZXh0LmF0cnVsZSApIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWNsKHBhcnQpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBzYW1lSW5kZW50ID0gbmV4dC5pbmRlbnQubGVuZ3RoID09PSBwYXJ0LmluZGVudC5sZW5ndGg7XG4gICAgICAgICAgICAgICAgICAgIGlmICggc2FtZUluZGVudCApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGVjbChwYXJ0KTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICggIXNhbWVJbmRlbnQgJiYgbmV4dC5jb2xvbiApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucnVsZShwYXJ0KTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICggIXNhbWVJbmRlbnQgJiYgIW5leHQuY29sb24gKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRlY2wocGFydCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2UgaWYgKCBwYXJ0LmVuZCApIHtcbiAgICAgICAgICAgICAgICB0aGlzLnJvb3QucmF3cy5hZnRlciA9IHBhcnQuYmVmb3JlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnJ1bGUocGFydCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMucG9zICs9IDE7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjb21tZW50KHBhcnQpIHtcbiAgICAgICAgbGV0IHRva2VuID0gcGFydC50b2tlbnNbMF07XG4gICAgICAgIGxldCBub2RlICA9IG5ldyBDb21tZW50KCk7XG4gICAgICAgIHRoaXMuaW5pdChub2RlLCBwYXJ0KTtcbiAgICAgICAgbm9kZS5zb3VyY2UuZW5kID0geyBsaW5lOiB0b2tlbls0XSwgY29sdW1uOiB0b2tlbls1XSB9O1xuXG4gICAgICAgIGxldCB0ZXh0ID0gdG9rZW5bMV07XG4gICAgICAgIGlmICggdG9rZW5bNl0gPT09ICdpbmxpbmUnICkge1xuICAgICAgICAgICAgbm9kZS5yYXdzLmlubGluZSA9IHRydWU7XG4gICAgICAgICAgICB0ZXh0ID0gdGV4dC5zbGljZSgyKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRleHQgPSB0ZXh0LnNsaWNlKDIsIC0yKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBtYXRjaCA9IHRleHQubWF0Y2goL14oXFxzKikoW15dKlteXFxzXSkoXFxzKilcXG4/JC8pO1xuICAgICAgICBub2RlLnRleHQgPSBtYXRjaFsyXTtcbiAgICAgICAgbm9kZS5yYXdzLmxlZnQgPSBtYXRjaFsxXTtcbiAgICAgICAgbm9kZS5yYXdzLmlubGluZVJpZ2h0ID0gbWF0Y2hbM107XG4gICAgfVxuXG4gICAgYXRydWxlKHBhcnQpIHtcbiAgICAgICAgbGV0IGF0d29yZCA9IHBhcnQudG9rZW5zWzBdO1xuICAgICAgICBsZXQgcGFyYW1zID0gcGFydC50b2tlbnMuc2xpY2UoMSk7XG5cbiAgICAgICAgbGV0IG5vZGUgID0gbmV3IEF0UnVsZSgpO1xuICAgICAgICBub2RlLm5hbWUgPSBhdHdvcmRbMV0uc2xpY2UoMSk7XG4gICAgICAgIHRoaXMuaW5pdChub2RlLCBwYXJ0KTtcblxuICAgICAgICBpZiAoIG5vZGUubmFtZSA9PT0gJycgKSB0aGlzLnVubmFtZWRBdHJ1bGUoYXR3b3JkKTtcblxuICAgICAgICB3aGlsZSAoICFwYXJ0LmVuZCAmJiBwYXJ0Lmxhc3RDb21tYSApIHtcbiAgICAgICAgICAgIHRoaXMucG9zICs9IDE7XG4gICAgICAgICAgICBwYXJ0ID0gdGhpcy5wYXJ0c1t0aGlzLnBvc107XG4gICAgICAgICAgICBwYXJhbXMucHVzaChbJ3NwYWNlJywgcGFydC5iZWZvcmUgKyBwYXJ0LmluZGVudF0pO1xuICAgICAgICAgICAgcGFyYW1zID0gcGFyYW1zLmNvbmNhdChwYXJ0LnRva2Vucyk7XG4gICAgICAgIH1cblxuICAgICAgICBub2RlLnJhd3MuYWZ0ZXJOYW1lID0gdGhpcy5maXJzdFNwYWNlcyhwYXJhbXMpO1xuICAgICAgICB0aGlzLmtlZXBUcmFpbGluZ1NwYWNlKG5vZGUsIHBhcmFtcyk7XG4gICAgICAgIHRoaXMucmF3KG5vZGUsICdwYXJhbXMnLCBwYXJhbXMsIGF0d29yZCk7XG4gICAgfVxuXG4gICAgZGVjbChwYXJ0KSB7XG4gICAgICAgIGxldCBub2RlID0gbmV3IERlY2xhcmF0aW9uKCk7XG4gICAgICAgIHRoaXMuaW5pdChub2RlLCBwYXJ0KTtcblxuICAgICAgICBsZXQgYmV0d2VlbiA9ICcnO1xuICAgICAgICBsZXQgY29sb24gICA9IDA7XG4gICAgICAgIGxldCB2YWx1ZSAgID0gW107XG4gICAgICAgIGxldCBwcm9wICAgID0gJyc7XG4gICAgICAgIGZvciAoIGxldCBpID0gMDsgaSA8IHBhcnQudG9rZW5zLmxlbmd0aDsgaSsrICkge1xuICAgICAgICAgICAgbGV0IHRva2VuID0gcGFydC50b2tlbnNbaV07XG4gICAgICAgICAgICBpZiAoIHRva2VuWzBdID09PSAnOicgKSB7XG4gICAgICAgICAgICAgICAgYmV0d2VlbiArPSB0b2tlblsxXTtcbiAgICAgICAgICAgICAgICBjb2xvbiAgICA9IHRva2VuO1xuICAgICAgICAgICAgICAgIHZhbHVlICAgID0gcGFydC50b2tlbnMuc2xpY2UoaSArIDEpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfSBlbHNlIGlmICggdG9rZW5bMF0gPT09ICdjb21tZW50JyB8fCB0b2tlblswXSA9PT0gJ3NwYWNlJyApIHtcbiAgICAgICAgICAgICAgICBiZXR3ZWVuICs9IHRva2VuWzFdO1xuICAgICAgICAgICAgfSBlbHNlIGlmICggYmV0d2VlbiAhPT0gJycgKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5iYWRQcm9wKHRva2VuKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcHJvcCArPSB0b2tlblsxXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmICggcHJvcCA9PT0gJycgKSB0aGlzLnVubmFtZWREZWNsKHBhcnQudG9rZW5zWzBdKTtcbiAgICAgICAgbm9kZS5wcm9wID0gcHJvcDtcblxuICAgICAgICBsZXQgbmV4dCA9IHRoaXMucGFydHNbdGhpcy5wb3MgKyAxXTtcblxuICAgICAgICB3aGlsZSAoICFuZXh0LmVuZCAmJiAhbmV4dC5hdHJ1bGUgJiYgIW5leHQuY29sb24gJiZcbiAgICAgICAgICAgICAgICBuZXh0LmluZGVudC5sZW5ndGggPiBwYXJ0LmluZGVudC5sZW5ndGggKSB7XG4gICAgICAgICAgICB2YWx1ZS5wdXNoKFsnc3BhY2UnLCBuZXh0LmJlZm9yZSArIG5leHQuaW5kZW50XSk7XG4gICAgICAgICAgICB2YWx1ZSA9IHZhbHVlLmNvbmNhdChuZXh0LnRva2Vucyk7XG4gICAgICAgICAgICB0aGlzLnBvcyArPSAxO1xuICAgICAgICAgICAgbmV4dCA9IHRoaXMucGFydHNbdGhpcy5wb3MgKyAxXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGZvciAoIGxldCBpID0gdmFsdWUubGVuZ3RoIC0gMTsgaSA+IDA7IGktLSApIHtcbiAgICAgICAgICAgIGxldCB0ID0gdmFsdWVbaV1bMF07XG4gICAgICAgICAgICBpZiAoIHQgPT09ICd3b3JkJyAmJiB2YWx1ZVtpXVsxXSA9PT0gJyFpbXBvcnRhbnQnICkge1xuICAgICAgICAgICAgICAgIG5vZGUuaW1wb3J0YW50ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBpZiAoIGkgPiAwICYmIHZhbHVlW2kgLSAxXVswXSA9PT0gJ3NwYWNlJyApIHtcbiAgICAgICAgICAgICAgICAgICAgbm9kZS5yYXdzLmltcG9ydGFudCA9IHZhbHVlW2kgLSAxXVsxXSArICchaW1wb3J0YW50JztcbiAgICAgICAgICAgICAgICAgICAgdmFsdWUuc3BsaWNlKGkgLSAxLCAyKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBub2RlLnJhd3MuaW1wb3J0YW50ID0gJyFpbXBvcnRhbnQnO1xuICAgICAgICAgICAgICAgICAgICB2YWx1ZS5zcGxpY2UoaSwgMSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfSBlbHNlIGlmICggdCAhPT0gJ3NwYWNlJyAmJiB0ICE9PSAnbmV3bGluZScgJiYgdCAhPT0gJ2NvbW1lbnQnICkge1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgbm9kZS5yYXdzLmJldHdlZW4gPSBiZXR3ZWVuICsgdGhpcy5maXJzdFNwYWNlcyh2YWx1ZSk7XG4gICAgICAgIHRoaXMucmF3KG5vZGUsICd2YWx1ZScsIHZhbHVlLCBjb2xvbik7XG4gICAgfVxuXG4gICAgcnVsZShwYXJ0KSB7XG4gICAgICAgIGxldCBub2RlID0gbmV3IFJ1bGUoKTtcbiAgICAgICAgdGhpcy5pbml0KG5vZGUsIHBhcnQpO1xuXG4gICAgICAgIGxldCBzZWxlY3RvciA9IHBhcnQudG9rZW5zO1xuICAgICAgICBsZXQgbmV4dCAgICAgPSB0aGlzLnBhcnRzW3RoaXMucG9zICsgMV07XG5cbiAgICAgICAgd2hpbGUgKCAhbmV4dC5lbmQgJiYgbmV4dC5pbmRlbnQubGVuZ3RoID09PSBwYXJ0LmluZGVudC5sZW5ndGggKSB7XG4gICAgICAgICAgICBzZWxlY3Rvci5wdXNoKFsnc3BhY2UnLCBuZXh0LmJlZm9yZSArIG5leHQuaW5kZW50XSk7XG4gICAgICAgICAgICBzZWxlY3RvciA9IHNlbGVjdG9yLmNvbmNhdChuZXh0LnRva2Vucyk7XG4gICAgICAgICAgICB0aGlzLnBvcyArPSAxO1xuICAgICAgICAgICAgbmV4dCA9IHRoaXMucGFydHNbdGhpcy5wb3MgKyAxXTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMua2VlcFRyYWlsaW5nU3BhY2Uobm9kZSwgc2VsZWN0b3IpO1xuICAgICAgICB0aGlzLnJhdyhub2RlLCAnc2VsZWN0b3InLCBzZWxlY3Rvcik7XG4gICAgfVxuXG4gICAgLyogSGVscGVycyAqL1xuXG4gICAgaW5kZW50KHBhcnQpIHtcbiAgICAgICAgbGV0IGluZGVudCA9IHBhcnQuaW5kZW50Lmxlbmd0aDtcbiAgICAgICAgbGV0IGlzUHJldiA9IHR5cGVvZiB0aGlzLnByZXZJbmRlbnQgIT09ICd1bmRlZmluZWQnO1xuXG4gICAgICAgIGlmICggIWlzUHJldiAmJiBpbmRlbnQgKSB0aGlzLmluZGVudGVkRmlyc3RMaW5lKHBhcnQpO1xuXG4gICAgICAgIGlmICggIXRoaXMuc3RlcCAmJiBpbmRlbnQgKSB7XG4gICAgICAgICAgICB0aGlzLnN0ZXAgPSBpbmRlbnQ7XG4gICAgICAgICAgICB0aGlzLnJvb3QucmF3cy5pbmRlbnQgPSBwYXJ0LmluZGVudDtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICggaXNQcmV2ICYmIHRoaXMucHJldkluZGVudCAhPT0gaW5kZW50ICkge1xuICAgICAgICAgICAgbGV0IGRpZmYgPSBpbmRlbnQgLSB0aGlzLnByZXZJbmRlbnQ7XG4gICAgICAgICAgICBpZiAoIGRpZmYgPiAwICkge1xuICAgICAgICAgICAgICAgIGlmICggZGlmZiAhPT0gdGhpcy5zdGVwICkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLndyb25nSW5kZW50KHRoaXMucHJldkluZGVudCArIHRoaXMuc3RlcCwgaW5kZW50LCBwYXJ0KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnQgPSB0aGlzLmN1cnJlbnQubGFzdDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2UgaWYgKCBkaWZmICUgdGhpcy5zdGVwICE9PSAwICkge1xuICAgICAgICAgICAgICAgIGxldCBtID0gaW5kZW50ICsgZGlmZiAlIHRoaXMuc3RlcDtcbiAgICAgICAgICAgICAgICB0aGlzLndyb25nSW5kZW50KGAkeyBtIH0gb3IgJHsgbSArIHRoaXMuc3RlcCB9YCwgaW5kZW50LCBwYXJ0KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZm9yICggbGV0IGkgPSAwOyBpIDwgLWRpZmYgLyB0aGlzLnN0ZXA7IGkrKyApIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50ID0gdGhpcy5jdXJyZW50LnBhcmVudDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnByZXZJbmRlbnQgPSBpbmRlbnQ7XG4gICAgfVxuXG4gICAgaW5pdChub2RlLCBwYXJ0KSB7XG4gICAgICAgIHRoaXMuaW5kZW50KHBhcnQpO1xuXG4gICAgICAgIGlmICggIXRoaXMuY3VycmVudC5ub2RlcyApIHRoaXMuY3VycmVudC5ub2RlcyA9IFtdO1xuICAgICAgICB0aGlzLmN1cnJlbnQucHVzaChub2RlKTtcblxuICAgICAgICBub2RlLnJhd3MuYmVmb3JlID0gcGFydC5iZWZvcmUgKyBwYXJ0LmluZGVudDtcbiAgICAgICAgbm9kZS5zb3VyY2UgPSB7XG4gICAgICAgICAgICBzdGFydDogeyBsaW5lOiBwYXJ0LnRva2Vuc1swXVsyXSwgY29sdW1uOiBwYXJ0LnRva2Vuc1swXVszXSB9LFxuICAgICAgICAgICAgaW5wdXQ6IHRoaXMuaW5wdXRcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBrZWVwVHJhaWxpbmdTcGFjZShub2RlLCB0b2tlbnMpIHtcbiAgICAgICAgbGV0IGxhc3RTcGFjZSA9IHRva2Vuc1t0b2tlbnMubGVuZ3RoIC0gMV07XG4gICAgICAgIGlmICggbGFzdFNwYWNlICYmIGxhc3RTcGFjZVswXSA9PT0gJ3NwYWNlJyApIHtcbiAgICAgICAgICAgIHRva2Vucy5wb3AoKTtcbiAgICAgICAgICAgIG5vZGUucmF3cy5zc3NCZXR3ZWVuID0gbGFzdFNwYWNlWzFdO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZmlyc3RTcGFjZXModG9rZW5zKSB7XG4gICAgICAgIGxldCByZXN1bHQgPSAnJztcbiAgICAgICAgZm9yICggbGV0IGkgPSAwOyBpIDwgdG9rZW5zLmxlbmd0aDsgaSsrICkge1xuICAgICAgICAgICAgaWYgKCB0b2tlbnNbaV1bMF0gPT09ICdzcGFjZScgfHwgdG9rZW5zW2ldWzBdID09PSAnbmV3bGluZScgKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0ICs9IHRva2Vucy5zaGlmdCgpWzFdO1xuICAgICAgICAgICAgICAgIGkgLT0gMTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICByYXcobm9kZSwgcHJvcCwgdG9rZW5zLCBhbHRMYXN0KSB7XG4gICAgICAgIGxldCB0b2tlbiwgdHlwZTtcbiAgICAgICAgbGV0IGxlbmd0aCA9IHRva2Vucy5sZW5ndGg7XG4gICAgICAgIGxldCB2YWx1ZSAgPSAnJztcbiAgICAgICAgbGV0IGNsZWFuICA9IHRydWU7XG4gICAgICAgIGZvciAoIGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAxICkge1xuICAgICAgICAgICAgdG9rZW4gPSB0b2tlbnNbaV07XG4gICAgICAgICAgICB0eXBlICA9IHRva2VuWzBdO1xuICAgICAgICAgICAgaWYgKCB0eXBlID09PSAnY29tbWVudCcgfHwgdHlwZSA9PT0gJ3NwYWNlJyAmJiBpID09PSBsZW5ndGggLSAxICkge1xuICAgICAgICAgICAgICAgIGNsZWFuID0gZmFsc2U7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHZhbHVlICs9IHRva2VuWzFdO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICggIWNsZWFuICkge1xuICAgICAgICAgICAgbGV0IHNzcyA9IHRva2Vucy5yZWR1Y2UoIChhbGwsIGkpID0+IGFsbCArIGlbMV0sICcnKTtcbiAgICAgICAgICAgIGxldCByYXcgPSB0b2tlbnMucmVkdWNlKCAoYWxsLCBpKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCBpWzBdID09PSAnY29tbWVudCcgJiYgaVs2XSA9PT0gJ2lubGluZScgKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBhbGwgKyAnLyogJyArIGlbMV0uc2xpY2UoMikudHJpbSgpICsgJyAqLyc7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFsbCArIGlbMV07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSwgJycpO1xuICAgICAgICAgICAgbm9kZS5yYXdzW3Byb3BdID0geyB2YWx1ZSwgcmF3IH07XG4gICAgICAgICAgICBpZiAoIHNzcyAhPT0gcmF3ICkgbm9kZS5yYXdzW3Byb3BdLnNzcyA9IHNzcztcbiAgICAgICAgfVxuICAgICAgICBub2RlW3Byb3BdID0gdmFsdWU7XG5cbiAgICAgICAgbGV0IGxhc3QgPSB0b2tlbnNbdG9rZW5zLmxlbmd0aCAtIDFdIHx8IGFsdExhc3Q7XG4gICAgICAgIG5vZGUuc291cmNlLmVuZCA9IHtcbiAgICAgICAgICAgIGxpbmU6ICAgbGFzdFs0XSB8fCBsYXN0WzJdLFxuICAgICAgICAgICAgY29sdW1uOiBsYXN0WzVdIHx8IGxhc3RbM11cbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBuZXh0Tm9uQ29tbWVudChwb3MpIHtcbiAgICAgICAgbGV0IG5leHQgPSBwb3M7XG4gICAgICAgIGxldCBwYXJ0O1xuICAgICAgICB3aGlsZSAoIG5leHQgPCB0aGlzLnBhcnRzLmxlbmd0aCApIHtcbiAgICAgICAgICAgIG5leHQgKz0gMTtcbiAgICAgICAgICAgIHBhcnQgPSB0aGlzLnBhcnRzW25leHRdO1xuICAgICAgICAgICAgaWYgKCBwYXJ0LmVuZCB8fCAhcGFydC5jb21tZW50ICkgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHBhcnQ7XG4gICAgfVxuXG4gICAgLy8gRXJyb3JzXG5cbiAgICBlcnJvcihtc2csIGxpbmUsIGNvbHVtbikge1xuICAgICAgICB0aHJvdyB0aGlzLmlucHV0LmVycm9yKG1zZywgbGluZSwgY29sdW1uKTtcbiAgICB9XG5cbiAgICB1bm5hbWVkQXRydWxlKHRva2VuKSB7XG4gICAgICAgIHRoaXMuZXJyb3IoJ0F0LXJ1bGUgd2l0aG91dCBuYW1lJywgdG9rZW5bMl0sIHRva2VuWzNdKTtcbiAgICB9XG5cbiAgICB1bm5hbWVkRGVjbCh0b2tlbikge1xuICAgICAgICB0aGlzLmVycm9yKCdEZWNsYXJhdGlvbiB3aXRob3V0IG5hbWUnLCB0b2tlblsyXSwgdG9rZW5bM10pO1xuICAgIH1cblxuICAgIGluZGVudGVkRmlyc3RMaW5lKHBhcnQpIHtcbiAgICAgICAgdGhpcy5lcnJvcignRmlyc3QgbGluZSBzaG91bGQgbm90IGhhdmUgaW5kZW50JywgcGFydC5udW1iZXIsIDEpO1xuICAgIH1cblxuICAgIHdyb25nSW5kZW50KGV4cGVjdGVkLCByZWFsLCBwYXJ0KSB7XG4gICAgICAgIGxldCBtc2cgPSBgRXhwZWN0ZWQgJHsgZXhwZWN0ZWQgfSBpbmRlbnQsIGJ1dCBnZXQgJHsgcmVhbCB9YDtcbiAgICAgICAgdGhpcy5lcnJvcihtc2csIHBhcnQubnVtYmVyLCAxKTtcbiAgICB9XG5cbiAgICBiYWRQcm9wKHRva2VuKSB7XG4gICAgICAgIHRoaXMuZXJyb3IoJ1VuZXhwZWN0ZWQgc2VwYXJhdG9yIGluIHByb3BlcnR5JywgdG9rZW5bMl0sIHRva2VuWzNdKTtcbiAgICB9XG5cbn1cbiJdfQ==